<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/diff.css /><link rel='stylesheet' href=../../../css/shell.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/kfs.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">design</a><ul><li><a href="#h2-1">查找 inode</a></li></ul><ul><li><a href="#h2-2">高效的 icache</a></li></ul><ul><li><a href="#h2-3">索引解析</a></li></ul><ul><li><a href="#h2-4">权限管理</a><ul><li><a href="#h3-5">代码解析</a></li></ul><ul><li><a href="#h3-6">功能说明</a></li></ul></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">design</h1><p>本项目参考了 <a href="https://github.com/gerard/ext4fuse" target="_blank">ext4fuse</a> 的基本设计和数据结构, 并重新设计了 cache/bitmap/dcache/dentry 部分, 高效的缓存 inode 和 dentry 信息, 大大减少了磁盘读写次数和内存拷贝的操作, 采用高效的指针访问;</p><p>同时本项目也实现了</p><ul><li><b>文件/目录</b>的<b>创建和删除</b></li></ul><ul><li><b>读写文件</b></li></ul><ul><li><b>权限管理</b></li></ul><ul><li>创建<b>硬链接</b> 和 <b>软链接</b></li></ul><ul><li>修改<b>访问时间</b>, 修改<b>权限</b>和<b>模式</b>等</li></ul><pre class="language-c"><code><span class="Token Keyword StorageType STATIC">static</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">fuse_operations</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">e4f_ops</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Initializer InitDeclarator BraceDepth-0 LCURLY_BRACE">{</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">init</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_init</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">getattr</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_getattr</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">access</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_access</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">readdir</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_readdir</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .releasedir = op_releasedir,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">readlink</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_readlink</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .mknod = op_mknod,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">mkdir</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_mkdir</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">link</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_link</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">symlink</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_symlink</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">unlink</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_unlink</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">rmdir</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_rmdir</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .rename = op_rename,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">chmod</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_chmod</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">chown</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_chown</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .truncate = op_truncate,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">utimens</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_utimens</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">open</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_open</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">flush</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_flush</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .fsync = op_fsync,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .release = op_release,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">read</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_read</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">write</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_write</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token COMMENT">// .statfs = op_statfs,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">create</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_create</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token Designator DOT">.</span><span class="Token Identifier Designator ID">destroy</span><span class="Token Identifier Designator SPACE"> </span><span class="Token Designation DesignationInitializer ASSIGN">=</span><span class="Token Designation DesignationInitializer SPACE"> </span><span class="Token Identifier PrimaryExpression ID">op_destory</span><span class="Token Initializer InitDeclarator COMMA">,</span><span class="Token Initializer InitDeclarator LF">
</span><span class="Token Initializer InitDeclarator BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><h2 id="h2-1">查找 inode</h2><p>查找 inode 时首先会从 decache 中查找, 如果找不到再依次深入目录遍历目录项, 如果找到了则会将目录项加入到 decache 当中方便下次查找</p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">inode_get_idx_by_path</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier CHAR">char</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">path</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">inode_idx</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">inode</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Looking up: </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">path</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// first try to find in dcache</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier HighlightLine ID">dcache_entry</span><span class="Token Identifier Structure StructureClass TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor HighlightLine ID">dc_entry</span><span class="Token Identifier DirectDeclaractor HighlightLine SPACE"> </span><span class="Token InitDeclarator HighlightLine ASSIGN">=</span><span class="Token InitDeclarator HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">get_cached_inode_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token UnaryOp UnaryExpression HighlightLine AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression HighlightLine ID">path</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token Declaration HighlightLine SEMI">;</span><span class="Token Declaration HighlightLine LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">dc_entry</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression QUESTION">?</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">dc_entry</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">inode_idx</span><span class="Token Identifier SPACE"> </span><span class="Token ConditionalExpression AssignmentExpression COLON">:</span><span class="Token ConditionalExpression AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">root</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">inode_idx</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Found inode_idx </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword IterationStatement DO">do</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">offset</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_dir_entry_2</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">de</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">skip_trailing_backslash</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint8_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">path_len</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">get_path_token_len</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path_len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement COMMENT">// Reached the end of the path</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// load inode by inode_idx</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">inode_get_by_number</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">dcache_init</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">dentry_next</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">offset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">offset</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ADD_ASSIGN">+=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">rec_len</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">inode_idx</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">name_len</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp EQ">==</span><span class="Token BinaryOp SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token CompoundStatement SelectionStatement COMMENT">// reach the ext4_dir_entry_tail</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ASSERT</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken BraceDepth-2 LPAREN">(</span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token Keyword STRUCT">struct</span><span class="Token Keyword SPACE"> </span><span class="Token Identifier ID">ext4_dir_entry_tail</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken MUL">*</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token Identifier ID">de</span><span class="Token PPtoken BraceDepth-2 RPAREN">)</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">det_reserved_ft</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken EQ">==</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier MacroDefine ID">EXT4_FT_DIR_CSUM</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;reach the last dentry&quot;</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;get dentry </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">[</span><span class="Token Format String STRING">%d</span><span class="Token String STRING">]&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">de</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">name</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">de</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token ExpressionStatement COMMENT">// if length not equal, continue</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path_len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp NE">!=</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">name_len</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">strncmp</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">name</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">path_len</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;not match dentry </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">de</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">name</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">                </span><span class="Token Keyword JumpStatement CONTINUE">continue</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement COMMENT">// Found the entry</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Found entry </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">, inode </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">de</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">name</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">de</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">inode_idx</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token ExpressionStatement COMMENT">// if the entry is a directory, add it to the cache</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Add dir entry </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">:</span><span class="Token Format String STRING">%d</span><span class="Token String STRING"> to dentry cache&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">path</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">path_len</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">dc_entry</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">decache_insert</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dc_entry</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">path_len</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement COMMENT">/* Couldn&#x27;t find the entry */</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">de</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Couldn&#x27;t find entry </span><span class="Token Format String STRING">%s</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">path</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement SPACE"> </span><span class="Token Keyword IterationStatement WHILE">while</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">strchr</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">path</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Char PrimaryExpression CHARACTER">&#x27;/&#x27;</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement LF">
</span><span class="Token IterationStatement LF">
</span><span class="Token IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240514140002.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240514140002.png" alt="20240514140002"></a></p><h2 id="h2-2">高效的 icache</h2><p>通过 inode_idx 查找 inode 会首先从 icache 中查找, 找不到的话再从磁盘中读取, 并加入 icache 中缓存</p><pre class="language-c"><code><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">inode_get_by_number</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">inode_idx</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">inode</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">ENOENT</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// first try to find in icache</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement HighlightLine SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier HighlightLine STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier HighlightLine SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier HighlightLine ID">ext4_inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier HighlightLine SPACE"> </span><span class="Token Pointer Declarator HighlightLine POINTER">*</span><span class="Token Identifier DirectDeclaractor HighlightLine ID">ic_entry</span><span class="Token Identifier DirectDeclaractor HighlightLine SPACE"> </span><span class="Token InitDeclarator HighlightLine ASSIGN">=</span><span class="Token InitDeclarator HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">icache_find</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 HighlightLine RPAREN">)</span><span class="Token Declaration HighlightLine SEMI">;</span><span class="Token Declaration HighlightLine LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">ic_entry</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Found inode_idx </span><span class="Token Format String STRING">%d</span><span class="Token String STRING"> in icache&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token UnaryOp UnaryExpression POINTER">*</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ic_entry</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// inode could not find in icache, read from disk and return the inode</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Not found inode_idx </span><span class="Token Format String STRING">%d</span><span class="Token String STRING"> in icache&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement HighlightLine SPACE">        </span><span class="Token UnaryOp UnaryExpression HighlightLine POINTER">*</span><span class="Token Identifier PrimaryExpression HighlightLine ID">inode</span><span class="Token Identifier PrimaryExpression HighlightLine SPACE"> </span><span class="Token AssignOp AssignmentExpression HighlightLine ASSIGN">=</span><span class="Token AssignOp AssignmentExpression HighlightLine SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall HighlightLine ID">icache_insert</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine LPAREN">(</span><span class="Token Identifier PrimaryExpression HighlightLine ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression HighlightLine COMMA">,</span><span class="Token PostfixExpression UnaryExpression HighlightLine SPACE"> </span><span class="Token Constant PrimaryExpression HighlightLine NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 HighlightLine RPAREN">)</span><span class="Token ExpressionStatement HighlightLine SEMI">;</span><span class="Token ExpressionStatement HighlightLine LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// update lru count of the inode</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ICACHE_LRU_INC</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token PPtoken MUL">*</span><span class="Token Identifier ID">inode</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>其中插入一个新的 icache_entry 后如果已经满了则采用 lru 算法进行替换, icache_entry 设置了 status 位用于标记 INVALID/VALID/DIRTY, 对于比如说 chmod/chown/utimens 这种对于 inode metadata 数据修改的操作, <b>不必立即写回磁盘</b>; 只需要修改status标记为 <b>DIRTY</b>, 读写都在内存中, 延迟到文件系统释放的时候再将数据同步更新回磁盘</p><pre class="language-c"><code><span class="Token COMMENT">/**
 * @brief insert a new inode into icache (LRU if exchange)
 *
 * @param inode_idx
 * @param read_from_disk if false, only register a new inode in i_cache instead of load from disk
    useful when inode_create() is called
 * @return struct ext4_inode*
 */</span><span class="Token LF">
</span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType ID">ext4_inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">icache_insert</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">inode_idx</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">read_from_disk</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ICACHE_MAX_COUNT</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;icache is full&quot;</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">icache_lru_replace</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">read_from_disk</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">entries</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">inode_idx</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">read_from_disk</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">off</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">inode_get_offset</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode_idx</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">            </span><span class="Token Identifier PrimaryExpression FunctionCall ID">disk_read</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">off</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-1 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_inode</span><span class="Token UnaryExpression CastExpression BraceDepth-1 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">entries</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">inode</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">entries</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">status</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ICACHE_S_VALID</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">entries</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">lru_count</span><span class="Token Identifier SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;insert inode </span><span class="Token Format String STRING">%d</span><span class="Token String STRING"> into icache&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">inode_idx</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">entries</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">icache</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">count</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression MINUS">-</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">inode</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-3">索引解析</h2><p>ext4 采用 extent tree 的索引结构, 对于 depth = 0 和 depth &gt; 0 的情况按照 <a href="../../fs/ext4" target="_self">ext4</a> 中介绍的模式递归查找</p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240527094310.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240527094310.png" alt="20240527094310"></a></p><p><a data-lightbox="example-1" href="https://raw.githubusercontent.com/learner-lu/picbed/master/20240527095313.png"><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20240527095313.png" alt="20240527095313"></a></p><pre class="language-c"><code><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">extent_get_pblock</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">extents</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">lblock</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint32_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">len</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent_header</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">eh</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">extents</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ee_array</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uint64_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">ret</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">ASSERT</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">eh</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">eh_magic</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken EQ">==</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier MacroDefine ID">EXT4_EXT_MAGIC</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">ASSERT</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">eh</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">eh_max</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken LE">&lt;=</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier MacroDefine ID">EXT4_EXT_LEAF_EH_MAX</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;reading inode extent, depth = </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">eh</span><span class="Token PPtoken POINT">-&gt;</span><span class="Token Identifier ID">eh_depth</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">eh</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">eh_depth</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// Leaf inode, direct block</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// 1 extent header + 4 extents</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">ee_array</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">extents</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent_header</span><span class="Token UnaryExpression CastExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">extent_get_block_from_ees</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">ee_array</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">eh</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">eh_entries</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lblock</span><span class="Token PostfixExpression UnaryExpression COMMA">,</span><span class="Token PostfixExpression UnaryExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent_idx</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ei_array</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">extents</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression PLUS">+</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Keyword UnaryExpression SIZEOF">sizeof</span><span class="Token UnaryExpression CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent_header</span><span class="Token UnaryExpression CastExpression BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_extent_idx</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">recurse_ei</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword IterationStatement FOR">for</span><span class="Token Keyword IterationStatement SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token Keyword BaseType TypeSpecifier INT">int</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration IterationStatement SEMI">;</span><span class="Token Declaration IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression LT">&lt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">eh</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">eh_entries</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression INC">++</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">ASSERT</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">ei_array</span><span class="Token PPtoken BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier ID">i</span><span class="Token PPtoken BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PPtoken DOT">.</span><span class="Token Identifier ID">ei_leaf_hi</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken EQ">==</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">ei_array</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token PostfixExpression UnaryExpression DOT">.</span><span class="Token Identifier ID">ei_block</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression GT">&gt;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">lblock</span><span class="Token SelectionStatement BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">                </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">            </span><span class="Token CompoundStatement SelectionStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">recurse_ei</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token UnaryOp UnaryExpression AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">ei_array</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RSQUAR_PAREN">]</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">ASSERT</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">recurse_ei</span><span class="Token Identifier SPACE"> </span><span class="Token PPtoken NE">!=</span><span class="Token PPtoken SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine ID">NULL</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword BaseType TypeSpecifier VOID">void</span><span class="Token Keyword BaseType TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">leaf_extents</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">extent_get_extents_in_block</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXT4_EXT_LEAF_ADDR</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">recurse_ei</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionName PrimaryExpression ID">extent_get_pblock</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">leaf_extents</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">lblock</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">len</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression FunctionCall ID">free</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">leaf_extents</span><span class="Token PostfixExpression UnaryExpression BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ret</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h2 id="h2-4">权限管理</h2><h3 id="h3-5">代码解析</h3><p>下面的C函数<code>inode_check_permission</code>根据用户的身份和请求的操作模式,检查并决定是否允许对指定inode(索引节点,代表文件或目录的元数据结构)的访问.</p><p><b>函数参数说明:</b></p><ul><li><code>inode</code>: 指向EXT4文件系统中inode结构的指针,包含文件的所有权信息(如所有者UID、所属组GID及权限位).</li></ul><ul><li><code>mode</code>: 用户尝试进行的操作模式,定义为<code>READ</code>(只读)、<code>WRITE</code>(只写)、<code>RDWR</code>(读写)、<code>EXEC</code>(执行)中的一个.</li></ul><pre class="language-c"><code><span class="Token Keyword StorageType TYPEDEF">typedef</span><span class="Token Keyword StorageType SPACE"> </span><span class="Token Keyword EnumSpecifier TypeSpecifier ENUM">enum</span><span class="Token Keyword EnumSpecifier TypeSpecifier SPACE"> </span><span class="Token EnumSpecifier BraceDepth-0 LCURLY_BRACE">{</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">READ</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">WRITE</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">RDWR</span><span class="Token EnumSpecifier COMMA">,</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier ID">EXEC</span><span class="Token Identifier MacroDefine Enumerator Enumerator TypeSpecifier SPACE"> </span><span class="Token EnumSpecifier BraceDepth-0 RCURLY_BRACE">}</span><span class="Token EnumSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor Typedefine TYPEDEF_ID">access_mode_t</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType INT">int</span><span class="Token Keyword BaseType TypeSpecifier FunctionReturnType SPACE"> </span><span class="Token Identifier DirectDeclaractor FunctionName FunctionName ID">inode_check_permission</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 LPAREN">(</span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">ext4_inode</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">inode</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">access_mode_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">mode</span><span class="Token DirectDeclaractor Declarator BraceDepth-0 RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Token CompoundStatement Function BraceDepth-0 LCURLY_BRACE">{</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token CompoundStatement Function COMMENT">// UNIX permission check</span><span class="Token CompoundStatement Function LF">
</span><span class="Token CompoundStatement Function SPACE">    </span><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">fuse_context</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">cntx</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">fuse_get_context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">//获取当前用户的上下文</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">uid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">cntx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">uid</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">cntx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">gid</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i_uid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXT4_INODE_UID</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">inode</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i_gid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">EXT4_INODE_GID</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token Identifier ID">inode</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;check inode &amp; user permission on op mode </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">mode</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;inode uid </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">, inode gid </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">i_uid</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">i_gid</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">DEBUG</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;user uid </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">, user gid </span><span class="Token Format String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">uid</span><span class="Token PPtoken COMMA">,</span><span class="Token PPtoken SPACE"> </span><span class="Token Identifier ID">gid</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// allow for root</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">uid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token String STRING">&quot;Permission granted&quot;</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// user check</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i_uid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">uid</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">READ</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IRUSR</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">WRITE</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IWUSR</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">RDWR</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IRUSR</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IWUSR</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">EXEC</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IXUSR</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Permission granted&quot;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// group check</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i_gid</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression EQ">==</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">gid</span><span class="Token SelectionStatement BraceDepth-1 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">READ</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IRGRP</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">WRITE</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IWGRP</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">RDWR</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IRGRP</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IWGRP</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">EXEC</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IXGRP</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Permission granted&quot;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// other check</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">READ</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IROTH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">WRITE</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IWOTH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">RDWR</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IROTH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">S_IWOTH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-2 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression OR">||</span><span class="Token BinaryOp ConditionalExpression LF">
</span><span class="Token BinaryOp ConditionalExpression SPACE">            </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mode</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="Token BinaryOp BinaryOp EQ">==</span><span class="Token BinaryOp BinaryOp SPACE"> </span><span class="Token Identifier Enumerator PrimaryExpression ID">EXEC</span><span class="Token Identifier Enumerator PrimaryExpression SPACE"> </span><span class="Token BinaryOp ConditionalExpression AND">&amp;&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">inode</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">i_mode</span><span class="Token Identifier SPACE"> </span><span class="Token BinaryOp ConditionalExpression AMPERSAND">&amp;</span><span class="Token BinaryOp ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">S_IXOTH</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-1 RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression BraceDepth-0 RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token String STRING">&quot;Permission granted&quot;</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token MacroDefine Identifier MacroDefine PrimaryExpression ID">INFO</span><span class="Token BraceDepth-1 LPAREN">(</span><span class="Token String STRING">&quot;Permission denied&quot;</span><span class="Token BraceDepth-1 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token UnaryOp UnaryExpression MINUS">-</span><span class="Token Identifier MacroDefine PrimaryExpression ID">EACCES</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token CompoundStatement Function BraceDepth-0 RCURLY_BRACE">}</span></code></pre><h3 id="h3-6">功能说明</h3><p>(1)获取用户上下文</p><p>使用<code>fuse_get_context()</code>获取当前发起操作的用户上下文,包括用户ID(<code>uid</code>)和组ID(<code>gid</code>).</p><ul><li><b>id</b>:是一个命令行工具,用于显示当前用户的身份号码,包括用户ID(UID)和组ID(GID).在FUSE文件系统中,这些身份号码通常用于权限检查.</li></ul><ul><li><b>uid</b>:用户身份号码</li></ul><ul><li><b>gid</b>:某用户所属的用户组号码,该用户加入用户组后就拥有了这些用户组成员共同拥有的权限.</li></ul><pre class="language-c"><code><span class="Token Keyword StructureType Structure TypeSpecifier STRUCT">struct</span><span class="Token Keyword StructureType Structure TypeSpecifier SPACE"> </span><span class="Token Identifier Structure StructureClass TypeSpecifier ID">fuse_context</span><span class="Token Identifier Structure StructureClass TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">ctx</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression FunctionCall ID">fuse_get_context</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 LPAREN">(</span><span class="Token PostfixExpression UnaryExpression BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">uid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">uid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ctx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">uid</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">//用户ID</span><span class="Token Declaration LF">
</span><span class="Token Keyword Typedefine TypeSpecifier TYPEDEF_ID">gid_t</span><span class="Token Keyword Typedefine TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">gid</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">ctx</span><span class="Token PostfixExpression UnaryExpression POINT">-&gt;</span><span class="Token Identifier ID">gid</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">//组ID</span></code></pre><p>(2)inode权限检查</p><ul><li>在执行任何文件操作之前,需要先检查当前用户的身份是否有权限执行该操作,通常在每个文件操作的回调函数中完成.</li></ul><ul><li>在FUSE中,inode通常包含有关文件权限的信息.我们需要实现一个函数来检查给定用户是否有权限访问inode.</li></ul><p>①超级用户检查</p><p>命令行工具su和sudo常用来切换超级用户.</p><ul><li><b>su</b>(替代用户)允许用户以另一个用户的身份运行shell.通常用于切换到root用户或其他具有更高权限的用户.</li></ul><ul><li><b>sudo</b>(超级用户执行)允许授权的用户以另一个用户(通常是root)的身份执行命令,而无需共享root密码.</li></ul><p>如果当前用户是root(<code>uid == 0</code>),由于root具有系统最高权限,直接允许所有操作.</p><p>②所有者权限检查</p><p>比较inode的所有者UID与当前用户的UID.如果匹配且请求的操作模式与inode权限位(如<code>S_IRUSR</code>读权限、<code>S_IWUSR</code>写权限)相符合,则允许访问.</p><p>③组用户权限检查</p><p>如果inode的所属组GID与当前用户所在的组GID相同,且权限位(如<code>S_IRGRP</code>、<code>S_IWGRP</code>)满足请求的操作模式,则权限被授予.</p><p>④其他用户权限检查</p><p>除了uid和gid外,还要检查其他用户</p><p>最后,检查inode针对&quot;其他人&quot;的权限位(如<code>S_IROTH</code>、<code>S_IWOTH</code>).如果这些权限位允许请求的操作,则访问被许可.</p><p>⑤权限拒绝处理</p><p>如果以上所有条件都不满足,则通过返回<code>-EACCES</code>错误码,表明访问被拒绝.</p><p>(3)更改权限和所有权</p><p>我们还可以实现<code>op_chmod</code>和<code>op_chown</code>等操作来允许用户更改文件权限和所有权.</p><p>op_chmod更改文件权限</p><p>更改文件的权限有两种表示方法,一种是用数字表示权限,另一种是用 <code>rwx</code> 表示权限.为了说明怎么用数字表示权限,我们得先来了解一下八进制.<code>chmod</code> 代表&quot;更改模式&quot;(change mode),是一个用于更改文件或目录权限的命令行工具.它允许用户设置读(r)、写(w)和执行(x)权限.</p><p>op_chown更改文件所有者</p><p><b>chown</b>是一个命令行工具,用于更改文件或目录的所有者.这通常需要管理员权限.</p><p><b>chgrp</b>:是一个更改组的命令行工具,用于更改文件或目录的组所有权.与<code>chown</code>类似,这通常需要管理员权限.</p><p>为了使权限检查功能完备,我们需要在<code>inode_check_permission</code>函数中加入实际的权限验证代码.这通常涉及以下步骤:</p><ol start="1"><li><b>权限掩码比对</b>:利用inode中的权限位(如读权限为4,写权限为2,执行权限为1)与用户身份进行比对.对于文件所有者、同组用户、其他用户分别有不同的权限设定.</li></ol><ol start="2"><li><b>特殊权限处理</b>:考虑SUID、SGID、sticky bit等特殊权限标志的影响.</li></ol><ol start="3"><li><b>错误处理</b>:当权限检查不通过时,应当有明确的错误处理逻辑,例如返回非零值表示权限拒绝.</li></ol></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../fs/storage" >fs</a><ul><li><a href="../../fs/storage" >storage</a></li></ul><ul><li><a href="../../fs/filesystem" >filesystem</a></li></ul><ul><li><a href="../../fs/fd" >fd</a></li></ul><ul><li><a href="../../fs/inode" >inode</a></li></ul><ul><li><a href="../../fs/directory" >directory</a></li></ul><ul><li><a href="../../fs/disk-layout" >disk-layout</a></li></ul><ul><li><a href="../../fs/ext4" >ext4</a></li></ul><ul><li><a href="../../fs/fuse" >fuse</a></li></ul><ul><li><a href="../../fs/permission" >permission</a></li></ul><ul><li><a href="../../fs/mount" >mount</a></li></ul><ul><li><a href="../../fs/performance" >performance</a></li></ul></li></ul><ul><li><a href="../../impl/mkfs" >impl</a><ul><li><a href="../../impl/mkfs" >mkfs</a></li></ul><ul><li><a href="../../impl/design" >design</a></li></ul><ul><li><a href="../../impl/kfsd" >kfsd</a></li></ul></li></ul><ul><li><a href="../../device/io" >device</a><ul><li><a href="../../device/io" >io</a></li></ul><ul><li><a href="../../device/disk" >disk</a></li></ul><ul><li><a href="../../device/ssd" >ssd</a></li></ul><ul><li><a href="../../device/driver" >driver</a></li></ul></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../impl/mkfs","../../impl/kfsd","ab");</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png");</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png");</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script>
            <script src="https://giscus.app/client.js" data-repo="luzhixing12345/kfs" 
            data-repo-id="R_kgDOLVMlxg" data-category="Q&A" data-category-id="DIC_kwDOLVMlxs4CgLTw" data-mapping="pathname" data-strict="0"
            data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom"
            data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async>
            </script>
            <script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>